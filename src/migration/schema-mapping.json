{
  "metadata": {
    "created": "2026-02-05T00:00:00Z",
    "phase": "3.1 Schema Mapping & Analysis",
    "version": "1.0",
    "purpose": "Complete mapping of Friday/MWR Firebase → Moonlanding SQLite transformation rules"
  },
  "field_type_mappings": {
    "firestore_timestamp": {
      "description": "Firestore server timestamp",
      "target_type": "TEXT",
      "format": "ISO 8601 UTC (YYYY-MM-DDTHH:MM:SS.sssZ)",
      "transformation": "Parse Firestore Timestamp → toISOString()"
    },
    "firestore_reference": {
      "description": "Firestore document reference",
      "target_type": "TEXT",
      "format": "Document ID string",
      "transformation": "Extract ID from reference path"
    },
    "firestore_array": {
      "description": "Firestore array field",
      "target_type": "Normalized table (1-to-many)",
      "format": "Create separate table with FK",
      "transformation": "Split array elements into separate rows"
    },
    "firestore_map": {
      "description": "Firestore map/object field",
      "target_type": "TEXT",
      "format": "JSON string",
      "transformation": "JSON.stringify() or store as-is if already JSON"
    },
    "firestore_string": {
      "description": "Firestore string",
      "target_type": "TEXT",
      "format": "UTF-8 string",
      "transformation": "Direct copy"
    },
    "firestore_number": {
      "description": "Firestore number (int or float)",
      "target_type": "INTEGER or REAL",
      "format": "Depends on precision needed",
      "transformation": "Direct copy (SQLite handles int/float)"
    },
    "firestore_boolean": {
      "description": "Firestore boolean",
      "target_type": "INTEGER",
      "format": "0 (false) or 1 (true)",
      "transformation": "Boolean to 0/1"
    },
    "firestore_geopoint": {
      "description": "Firestore GeoPoint",
      "target_type": "TEXT",
      "format": "JSON {\"latitude\": x, \"longitude\": y}",
      "transformation": "JSON.stringify()"
    },
    "firestore_bytes": {
      "description": "Firestore bytes",
      "target_type": "TEXT",
      "format": "Base64 string",
      "transformation": "Encode as base64"
    }
  },
  "critical_transformations": {
    "user_deduplication": {
      "description": "Handle 10-15% email-based user overlap between systems",
      "implementation": {
        "step_1_create_mapping_table": "CREATE TABLE user_id_mapping (firebase_id TEXT PRIMARY KEY, moonlanding_id TEXT NOT NULL, source TEXT NOT NULL, email TEXT NOT NULL)",
        "step_2_scan_friday_users": "For each user in Friday, check if email exists in Moonlanding",
        "step_3_create_or_map": "If email found: create mapping; If not: create new user and map",
        "step_4_update_foreign_keys": "Update all engagement.user_id, review.user_id, etc with new IDs",
        "step_5_verify": "Verify no orphaned references after mapping update"
      },
      "expected_impact": "User count reduction of 10-15% due to deduplication"
    },
    "pdf_coordinates_exact_preservation": {
      "description": "Critical: Preserve PDF highlight coordinates with ±0 pixels accuracy",
      "critical": true,
      "fields": ["x", "y", "page", "width", "height"],
      "validation": "Math.abs(source - target) === 0 for each coordinate",
      "warning": "No zoom/rotation/transform recalculation allowed",
      "implementation": "Copy field values directly without any calculation"
    },
    "timestamp_normalization": {
      "description": "Convert all timestamps to UTC ISO 8601 format",
      "format": "YYYY-MM-DDTHH:MM:SS.sssZ",
      "validation": "Timestamp must end with 'Z' and match ISO 8601 pattern",
      "implementation": "Firestore Timestamp → toISOString() → remove timezone offset if present"
    },
    "subcollection_normalization": {
      "description": "Convert Firestore subcollections to normalized SQLite tables",
      "example_rfi": {
        "firestore_path": "engagement/{engagementId}/rfi/{rfiId}/questions/{questionId}",
        "target_tables": ["rfi", "rfi_question", "rfi_response"],
        "rfi_table": "engagement_id, status, created_at, updated_at",
        "rfi_question_table": "rfi_id, question_text, order, created_at",
        "rfi_response_table": "rfi_question_id, response_text, created_at"
      },
      "example_messages": {
        "firestore_path": "engagement/{engagementId}/messages/{messageId}",
        "target_table": "messages",
        "foreign_key": "engagement_id"
      }
    },
    "file_path_migration": {
      "description": "Update file paths from Friday/MWR to Moonlanding storage",
      "transformation": {
        "friday": "/home/user/lexco/friday-staging/uploads/... → /home/user/lexco/moonlanding/uploads/...",
        "mwr": "/home/user/lexco/myworkreview-staging/uploads/... → /home/user/lexco/moonlanding/uploads/..."
      },
      "validation": "Verify file exists at new location before finalizing"
    }
  },
  "moonlanding_core_tables": {
    "users": {
      "description": "User accounts",
      "key_fields": ["id", "email", "name", "role", "type", "created_at", "updated_at"],
      "foreign_keys": [],
      "migration_source": ["friday.users", "mwr.users (deduplicated)"]
    },
    "clients": {
      "description": "Client organizations",
      "key_fields": ["id", "name", "industry", "status", "created_at"],
      "foreign_keys": [],
      "migration_source": ["friday.clients", "mwr.clients"]
    },
    "engagements": {
      "description": "Engagements between firm and clients",
      "key_fields": ["id", "client_id", "status", "stage", "start_date", "end_date", "created_at"],
      "foreign_keys": ["client_id → clients.id"],
      "migration_source": ["friday.engagement", "mwr.engagement"]
    },
    "rfi": {
      "description": "Request for Information",
      "key_fields": ["id", "engagement_id", "status", "created_at", "due_date"],
      "foreign_keys": ["engagement_id → engagements.id"],
      "migration_source": ["friday.engagement.rfi (normalized from subcollection)"]
    },
    "rfi_question": {
      "description": "Individual RFI question",
      "key_fields": ["id", "rfi_id", "question_text", "order", "created_at"],
      "foreign_keys": ["rfi_id → rfi.id"],
      "migration_source": ["friday.engagement.rfi.questions (normalized from subcollection)"]
    },
    "rfi_response": {
      "description": "Response to RFI question",
      "key_fields": ["id", "rfi_question_id", "user_id", "response_text", "created_at"],
      "foreign_keys": ["rfi_question_id → rfi_question.id", "user_id → users.id"],
      "migration_source": ["friday.engagement.rfi.responses"]
    },
    "reviews": {
      "description": "Document reviews",
      "key_fields": ["id", "engagement_id", "status", "created_at"],
      "foreign_keys": ["engagement_id → engagements.id"],
      "migration_source": ["friday.engagement.reviews (normalized)"]
    },
    "highlights": {
      "description": "PDF text highlights/annotations",
      "key_fields": ["id", "review_id", "x", "y", "page", "width", "height", "text", "created_at"],
      "foreign_keys": ["review_id → reviews.id"],
      "migration_source": ["friday.engagement.reviews.highlights (normalized from subcollection)"],
      "critical_note": "MUST preserve coordinates with ±0 pixels accuracy. No recalculation allowed."
    },
    "messages": {
      "description": "Communication messages",
      "key_fields": ["id", "engagement_id", "user_id", "content", "created_at"],
      "foreign_keys": ["engagement_id → engagements.id", "user_id → users.id"],
      "migration_source": ["friday.engagement.messages (normalized from subcollection)"]
    },
    "collaborators": {
      "description": "Users assigned to engagements",
      "key_fields": ["id", "engagement_id", "user_id", "role", "status", "assigned_at"],
      "foreign_keys": ["engagement_id → engagements.id", "user_id → users.id"],
      "migration_source": ["friday.collaborators", "mwr.collaborators"]
    },
    "checklist": {
      "description": "Task checklists",
      "key_fields": ["id", "engagement_id", "name", "status", "created_at"],
      "foreign_keys": ["engagement_id → engagements.id"],
      "migration_source": ["friday.engagement.checklists (normalized from subcollection)"]
    },
    "checklist_item": {
      "description": "Individual checklist item",
      "key_fields": ["id", "checklist_id", "task_name", "completed", "completed_at"],
      "foreign_keys": ["checklist_id → checklist.id"],
      "migration_source": ["friday.engagement.checklists.items (normalized from subcollection)"]
    },
    "files": {
      "description": "File references and metadata",
      "key_fields": ["id", "name", "path", "size", "mime_type", "created_at"],
      "foreign_keys": [],
      "migration_source": ["friday.files", "mwr.files"],
      "note": "Paths must be updated to Moonlanding storage location"
    },
    "activity_log": {
      "description": "Audit trail of all actions",
      "key_fields": ["id", "entity_type", "entity_id", "action", "user_id", "timestamp"],
      "foreign_keys": ["user_id → users.id"],
      "migration_source": ["friday.activity_log", "mwr.activity_log"]
    },
    "permissions": {
      "description": "Role-based access control",
      "key_fields": ["id", "user_id", "role", "resource_type", "resource_id"],
      "foreign_keys": ["user_id → users.id"],
      "migration_source": ["friday.permissions", "mwr.permissions"]
    }
  },
  "validation_requirements": {
    "row_count_matching": {
      "description": "Verify source and target record counts match (accounting for normalization)",
      "acceptance_criteria": "100% match or documented reason for variance"
    },
    "referential_integrity": {
      "description": "Verify all foreign key relationships are intact, no orphaned records",
      "acceptance_criteria": "PRAGMA foreign_key_check returns 0 violations"
    },
    "data_type_accuracy": {
      "description": "Verify all field type conversions completed correctly",
      "acceptance_criteria": "All fields match expected SQLite types"
    },
    "pdf_coordinate_preservation": {
      "description": "CRITICAL: Verify highlight coordinates preserved to ±0 pixels",
      "acceptance_criteria": "Math.abs(source - target) === 0 for 100% of coordinates"
    },
    "timestamp_normalization": {
      "description": "Verify all timestamps in UTC ISO 8601 format",
      "acceptance_criteria": "All timestamps match pattern YYYY-MM-DDTHH:MM:SS.sssZ"
    },
    "file_path_validation": {
      "description": "Verify file paths updated and files exist",
      "acceptance_criteria": "100% of file paths point to existing files"
    },
    "json_field_validity": {
      "description": "Verify JSON fields contain valid JSON",
      "acceptance_criteria": "JSON.parse() succeeds for 100% of JSON fields"
    },
    "constraint_enforcement": {
      "description": "Verify all SQLite constraints can be enforced",
      "acceptance_criteria": "PRAGMA foreign_key_check and constraint checks pass"
    }
  },
  "execution_checkpoints": {
    "checkpoint_1_schema_ready": {
      "description": "Complete schema analysis and create mapping",
      "blocking": ["All subsequent phases"]
    },
    "checkpoint_2_scripts_ready": {
      "description": "All migration scripts written and unit tested",
      "blocking": ["Sample testing", "Pilot testing", "Full migration"]
    },
    "checkpoint_3_validators_ready": {
      "description": "All 8 validators implemented and tested",
      "blocking": ["Sample validation", "Pilot validation", "Full validation"]
    },
    "checkpoint_4_sample_success": {
      "description": "1% sample migration passes all 8 validators",
      "blocking": ["Pilot testing"]
    },
    "checkpoint_5_pilot_success": {
      "description": "10% pilot migration passes all 8 validators",
      "blocking": ["Full migration"]
    },
    "checkpoint_6_full_migration_success": {
      "description": "100% data migrated and passes all 8 validators",
      "blocking": ["Production cutover"]
    },
    "checkpoint_7_verification_complete": {
      "description": "All 12 verification checks pass",
      "blocking": ["Parallel operations setup"]
    }
  }
}
