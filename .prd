# Moonlanding Platform - Product Requirements & Status

## Executive Summary

**Moonlanding** is an ultra-minimal unified platform combining engagement management, document review, and collaboration features. Built with **zero-build architecture** (tsx runtime), **SQLite** local database, and **Lucia** authentication.

**Current Status:** Phase 5 (Audit Trail) complete âœ…
**Architecture:** Intentionally lightweight to enable rapid iteration and no vendor lock-in
**Deployment:** Single Node.js server, buildless, fully control

---

## Comprehensive Feature Inventory

### Implemented Features âœ…

#### 1. Core Platform
- âœ… Zero-build runtime (tsx transpilation)
- âœ… SQLite database (better-sqlite3)
- âœ… Lucia authentication + Arctic OAuth
- âœ… Custom HTTP server (no Express bloat)
- âœ… Hot module reloading for configs
- âœ… Module cache invalidation

#### 2. Entity Management
- âœ… Entity CRUD operations via API
- âœ… Dynamic entity rendering
- âœ… Field render system (date, enum, text, etc)
- âœ… Status color coding
- âœ… Bulk actions toolbar
- âœ… Pagination support

#### 3. Review/Engagement System
- âœ… Review detail view with tabs
- âœ… Engagement lifecycle tracking
- âœ… Status transitions
- âœ… WIP value tracking
- âœ… Team assignment
- âœ… Financial year tracking

#### 4. PDF Management
- âœ… PDF viewer component
- âœ… File upload handling
- âœ… PDF rendering via Puppeteer
- âœ… MIME type detection
- âœ… Drive file integration

#### 5. Collaboration Features
- âœ… Checklist tracker
- âœ… Collaborator manager
- âœ… Comment section
- âœ… Chat panel (basic)
- âœ… Highlight layer
- âœ… Highlight annotator

#### 6. Email & Notifications
- âœ… Nodemailer integration
- âœ… Email template system
- âœ… SMTP configuration
- âœ… Transactional emails

#### 7. UI Components (66 total)
- âœ… Form components
- âœ… Dialog/modal system
- âœ… Table rendering
- âœ… Dashboard widgets
- âœ… Navigation components
- âœ… Status indicators

#### 8. Data Import/Export
- âœ… YAML config import
- âœ… CSV/JSON export support
- âœ… Bulk data operations
- âœ… Template management

#### 9. Configuration System
- âœ… Master config engine
- âœ… Dynamic enum options
- âœ… Workflow stage definitions
- âœ… Entity field definitions
- âœ… Icon configuration
- âœ… Theme configuration

#### 10. Google Integration
- âœ… Google Drive file handling
- âœ… googleapis library integrated
- âœ… Service account authentication
- âœ… File upload to Drive

#### 11. Audit Trail & Action Logging (NEW - Phase 5)
- âœ… Automatic tracking of all data mutations
- âœ… Before/after state snapshots
- âœ… User attribution on all actions
- âœ… Flexible audit log querying
- âœ… Pagination and filtering
- âœ… Statistics calculation
- âœ… CSV export of audit reports
- âœ… Timeline visualization component
- âœ… Full audit page with filter controls

---

### Missing Features (HIGH PRIORITY) âŒ

#### 1. RFI (Request For Information) System
**Status:** Not implemented
**Location needed:** src/components/rfi-*/, src/app/api/rfi/
**Pattern source:** friday-staging RFI system (17+ components)
**What's needed:**
- RFI template management
- Question creation and assignment
- Response tracking
- Deadline management
- Status workflow
- Response attachments
- RFI reports and analytics

**Database schema needed:**
```sql
CREATE TABLE rfis (
  id TEXT PRIMARY KEY,
  engagement_id TEXT,
  status TEXT,
  created_at DATETIME
);
CREATE TABLE rfi_questions (
  id TEXT PRIMARY KEY,
  rfi_id TEXT,
  question TEXT,
  category TEXT,
  assigned_to TEXT,
  due_date DATE
);
CREATE TABLE rfi_responses (
  id TEXT PRIMARY KEY,
  question_id TEXT,
  response TEXT,
  attachments JSON,
  created_at DATETIME
);
```

---

### Missing Features (MEDIUM PRIORITY) ğŸŸ¡

#### 2. Tender Management
**Status:** Basic fields exist (tender_id), no system
**What's needed:**
- Tender CRUD operations
- Bid tracking
- Deadline management
- Status workflow
- Client integration

#### 3. Google Drive Advanced Integration
**Status:** Basic upload/download exists
**What's needed:**
- Folder structure templates
- Batch operations
- Permissions sync
- File versioning
- Webhook integration

#### 4. Email Notification System
**Status:** Nodemailer installed, not integrated
**What's needed:**
- Event-triggered emails
- Email templates
- Recipient configuration
- Notification preferences
- Digest emails
- Unsubscribe handling

#### 5. Search & Filtering
**Status:** Basic pagination exists
**What's needed:**
- Full-text search
- Advanced filters
- Saved filters
- Search history
- Faceted search

#### 6. Workflow Automation
**Status:** Manual workflows only
**What's needed:**
- Automation rules
- Triggers (time, status change, etc)
- Actions (email, status update, etc)
- Conditional logic
- Approvals workflow

---

### Missing Features (LOW PRIORITY) ğŸŸ¢

#### 7. Performance Monitoring
- Error tracking
- Page performance metrics
- API response times
- User activity analytics

#### 8. Data Analytics Dashboard
- Engagement metrics
- Team productivity
- Status distribution
- Timeline insights

#### 9. Mobile PWA Features
- Offline support
- Push notifications
- Home screen install
- Background sync

#### 10. Advanced Export Options
- PDF reports with charts
- Excel workbooks
- Custom export templates
- Scheduled exports

---

## Architecture & Technical Decisions

### Why Zero-Build is Superior
- **Development speed:** No build step = instant code changes
- **Debugging:** Direct source code, no sourcemaps needed
- **Deployment:** Just copy files, run with tsx
- **Vendor lock-in:** No build tool dependencies
- **Bundle size:** No webpack bloat, minimal runtime

### Why SQLite Over Firebase
- **Cost:** Zero per-request costs
- **Control:** Full data ownership, local backup
- **Latency:** Sub-millisecond queries
- **Offline:** Can work offline with sync later
- **Simplicity:** No async complexities, sync API
- **Testing:** In-memory database for tests

### Why Not Mantine/MUI
- **Bloat:** Mantine = 2MB, MUI = 3MB+
- **Bundle:** Brings in emotion, floating-ui, etc
- **Maintenance:** Large API surface to learn
- **RippleUI alternative:** 40KB CSS, 36 components, TailwindCSS

### Why WebJSX + RippleUI
- **Minimal:** ~100 lines for createElement + applyDiff
- **Standards-based:** Just Web Components, no framework bloat
- **CSS-first:** RippleUI provides semantic CSS classes
- **Zero dependencies:** No package updates breaking code
- **Buildless:** Perfect complement to tsx runtime

---

## Dependency Management Strategy

### Current (Problematic)
- **Mantine 7.13:** ~2MB, many sub-dependencies
- **@mantine/hooks:** Custom hooks library
- **@mantine/notifications:** Toast/alert system
- **Total top-level:** ~30 dependencies

### Target (After Migration)
- **Remove:** Mantine, @mantine/*, @tabler/icons-react
- **Keep:** React, React-DOM (essential), Better-sqlite3, Lucia, googleapis, puppeteer, nodemailer
- **Add:** RippleUI CSS (~40KB), WebJSX (~5KB)
- **Total top-level:** ~20 dependencies
- **Reduction:** ~40% smaller node_modules

---

## Database Schema Evolution

### Current Tables
```
users, authentications, sessions, entities, 
entity_definitions, relationships, checklists, 
comments, attachments, ...
```

### Added in Phase 5
```
audit_logs (with 3 performance indexes)
```

### To Add (From Missing Features)
```
chat_messages, chat_mentions, pdf_highlights,
rfis, rfi_questions, rfi_responses,
workflows, notifications, saved_searches
```

---

## API Endpoints Status

### Implemented
```
/api/[entity]/        - CRUD
/api/[entity]/[id]    - Details
/api/auth/*           - Authentication
/api/upload           - File upload
/api/config           - Configuration
/api/audit            - Audit logs (Phase 5)
```

### To Add
```
/api/chat/           - Messages
/api/highlights/     - PDF annotations
/api/rfis/           - RFI operations
/api/permissions/    - RBAC checks
/api/workflows/      - Automation
```

---

## Component Migration Plan

### Phase 5: Audit Trail (âœ… COMPLETE)
- [x] Create audit logging middleware
- [x] Log all data mutations
- [x] Build audit report UI
- [x] Add filtering by user/entity/action

### Phase 6: RFI System
- [ ] Design RFI templates
- [ ] Build RFI CRUD UI
- [ ] Question assignment workflow
- [ ] Response tracking
- [ ] RFI reports

---

## Known Issues & TODOs

### Code Quality
- [x] Audit trail integration complete
- [ ] Domain.jsx is 194 lines - consider splitting
- [ ] FileReview.tsx in myworkreview is 183KB - avoid this pattern
- [ ] Add JSDoc comments to API handlers
- [ ] Improve error messages across API

### Performance
- [x] Audit logs use proper indexes for filtering
- [ ] Add query optimization for large datasets
- [x] Implement pagination throughout
- [ ] Optimize PDF rendering for large files
- [ ] Add caching for config system

### Testing
- [ ] Add end-to-end tests for all workflows
- [ ] Test RBAC enforcement
- [ ] Test offline behavior
- [ ] Load test with 1000+ entities

### Security
- [ ] Add CSRF protection if needed
- [ ] Validate all file uploads
- [ ] Sanitize HTML in comments
- [ ] Rate limit API endpoints

---

## Version & Deployment

**Current Version:** 1.0.0
**Target Version:** 2.0.0 (after feature completion)
**Deployment:** npm run dev (local), npm run build (production if needed)
**Server Port:** 3004
**Database:** data/app.db (SQLite)

---

## Comparison Matrix with Other Projects

| Feature | moonlanding | friday-staging | myworkreview |
|---------|-------------|-----------------|--------------|
| Zero-build | âœ… | âŒ | âŒ |
| SQLite | âœ… | âŒ | âŒ |
| RBAC | âœ… | âŒ | âœ… |
| Real-time Chat | âœ… | âŒ | âœ… |
| PDF Annotation | âœ… | âœ… | âœ… |
| RFI System | âŒ | âœ… | âŒ |
| Email System | ğŸŸ¡ | âœ… | âœ… |
| Audit Trail | âœ… | âŒ | âœ… |
| Component Count | 66 | 17 | 40+ |
| Dependencies | ~25 | ~50+ | ~50+ split |

---

## Success Criteria

âœ… **Phase 1 Complete:** All UI migrated to RippleUI, Mantine removed, no visual regressions
âœ… **Phase 2 Complete:** RBAC implemented, all endpoints protected, permissions enforced
âœ… **Phase 3 Complete:** Chat system persists messages, supports attachments, real-time updates
âœ… **Phase 4 Complete:** PDF annotations, comparison mode, highlight export working
âœ… **Phase 5 Complete:** All actions logged, audit trail queryable, statistics calculated
ğŸ”„ **Phase 6:** RFI system implementation (Next)
âœ… **Final:** Zero build dependencies, all core features working, under 200 lines per file

---

## Next Steps

1. âœ… Analyze comparison with other projects (DONE)
2. âœ… Phase 1: RippleUI migration complete (DONE)
3. âœ… Phase 2: RBAC implementation complete (DONE)
4. âœ… Phase 3: Chat system enhancement complete (DONE)
5. âœ… Phase 4: PDF Advanced Features complete (DONE)
6. âœ… Phase 5: Audit Trail & Action Logging complete (DONE)
7. ğŸ”„ Begin Phase 6: RFI System implementation
8. End-to-end testing
9. Production deployment
